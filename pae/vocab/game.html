<!-- File: classroom/pae/vocab/game.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAE Vocabulary Game</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../../css/styles.css">
    <!-- jsPDF for certificate generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="game-container">
        <nav class="breadcrumb-nav">
            <a href="../../../" class="text-white">
                <i class="bi bi-house"></i> Home
            </a>
            <span class="text-white-50 mx-2">/</span>
            <a href="../../" class="text-white">PAE</a>
            <span class="text-white-50 mx-2">/</span>
            <a href="../" class="text-white">Vocabulary</a>
            <span class="text-white-50 mx-2">/</span>
            <span class="text-white" id="chapterBreadcrumb">Chapter ?</span>
        </nav>

        <div class="game-card">
            <div class="timer-display" id="timerDisplay">30:00</div>
            
            <!-- Section 1: Chapter Info & Team Setup -->
            <div class="game-section active" id="setupSection">
                <h1 class="text-center mb-4">
                    <i class="bi bi-gear-fill text-primary"></i> 
                    <span id="chapterTitle">Chapter ? Vocabulary Game</span>
                </h1>
                
                <div class="alert alert-info mb-4">
                    <h4><i class="bi bi-info-circle"></i> Game Instructions</h4>
                    <ol class="mb-0">
                        <li>Teams take turns selecting point values (higher = harder)</li>
                        <li>You have 30 seconds to answer each question</li>
                        <li>If incorrect, the next team can steal for half points</li>
                        <li>Only the answering team may talk during their turn</li>
                    </ol>
                </div>
                
                <div class="row">
                    <div class="col-md-8 mx-auto">
                        <h3 class="text-center mb-4">Team Setup</h3>
                        <div class="mb-3">
                            <label class="form-label">Number of teams (2-6):</label>
                            <select class="form-control" id="numTeams" onchange="updateTeamInputs()">
                                <option value="2">2 Teams</option>
                                <option value="3">3 Teams</option>
                                <option value="4" selected>4 Teams</option>
                                <option value="5">5 Teams</option>
                                <option value="6">6 Teams</option>
                            </select>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>Team Member Names:</strong> Enter all team member names in each field (separated by commas if multiple students per team)
                        </div>
                        
                        <div id="teamInputs" class="team-setup">
                            <!-- Team inputs will be generated here -->
                        </div>
                        
                        <div class="text-center mt-4">
                            <button class="btn btn-primary btn-lg" onclick="startGame()">
                                <i class="bi bi-play-fill"></i> Start Game
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Section 2: Game Board -->
            <div class="game-section" id="gameSection">
                <h1 class="text-center mb-3">
                    <i class="bi bi-trophy-fill text-warning"></i> 
                    <span id="gameTitle">Chapter ? Vocabulary Game</span>
                </h1>
                
                <div class="team-scores" id="teamScores"></div>
                
                <div class="jeopardy-board" id="gameBoard">
                    <!-- Game board will be generated here -->
                </div>
                
                <div class="text-center mt-3">
                    <div class="countdown-timer" id="questionTimer" style="display: none;">30</div>
                    <div id="currentTeamDisplay" class="h4 text-primary"></div>
                </div>
            </div>
            
            <!-- Section 3: Game Complete -->
            <div class="game-section" id="completeSection">
                <h1 class="text-center mb-4">
                    <i class="bi bi-trophy text-warning"></i> 
                    Game Complete!
                </h1>
                
                <div class="alert alert-success text-center">
                    <h3>Final Results</h3>
                    <div id="finalScores" class="mt-3"></div>
                </div>
                
                <div class="text-center">
                    <button class="btn btn-success btn-lg me-3" onclick="generateCertificate()">
                        <i class="bi bi-download"></i> Get Certificate
                    </button>
                    <button class="btn btn-primary btn-lg me-3" onclick="playAgain()">
                        <i class="bi bi-arrow-repeat"></i> Play Again
                    </button>
                    <button class="btn btn-secondary btn-lg" onclick="selectNewChapter()">
                        <i class="bi bi-list"></i> Select New Chapter
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Audio Notice -->
    <div class="audio-notice">
        <i class="bi bi-volume-up"></i> Looking for audio files in: ../../media/ (correct.mp3, incorrect.mp3, ding-ding.mp3)
    </div>
    
    <!-- Question Modal -->
    <div class="question-modal" id="questionModal">
        <div class="question-content">
            <h3 id="questionPoints"></h3>
            <p id="questionText" class="fs-5"></p>
            <div id="answerOptions"></div>
            <div class="countdown-timer" id="modalTimer">30</div>
        </div>
    </div>
    
    <script>
        // Global Variables
        let currentChapter = 1;
        let vocabularyData = [];
        let teams = [];
        let currentTeam = 0;
        let gameActive = false;
        let questionTimer = null;
        let currentQuestion = null;
        let currentPoints = 0;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Get chapter from URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            currentChapter = parseInt(urlParams.get('chapter')) || 1;
            
            // Update UI with chapter info
            document.getElementById('chapterBreadcrumb').textContent = `Chapter ${currentChapter}`;
            document.getElementById('chapterTitle').textContent = `Chapter ${currentChapter} Vocabulary Game`;
            document.getElementById('gameTitle').textContent = `Chapter ${currentChapter} Vocabulary Game`;
            
            // Load vocabulary data
            loadVocabularyData();
            
            // Setup initial team inputs
            updateTeamInputs();
        });
        
        // Load vocabulary data from JSON file
        async function loadVocabularyData() {
            try {
                const response = await fetch(`ch${currentChapter}vocab.json`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                vocabularyData = await response.json();
                console.log(`Loaded ${vocabularyData.length} vocabulary items for Chapter ${currentChapter}`);
            } catch (error) {
                console.error('Error loading vocabulary data:', error);
                // Use sample data if file not found
                vocabularyData = getSampleData();
                alert(`Could not load ch${currentChapter}vocab.json. Using sample data for demonstration.`);
            }
        }
        
        // Generate team input fields based on number selected
        function updateTeamInputs() {
            const numTeams = parseInt(document.getElementById('numTeams').value);
            const container = document.getElementById('teamInputs');
            container.innerHTML = '';
            
            for (let i = 1; i <= numTeams; i++) {
                const div = document.createElement('div');
                div.className = 'mb-3';
                div.innerHTML = `
                    <label class="form-label fw-bold">Team ${i} Member Names:</label>
                    <input type="text" class="form-control form-control-lg" id="team${i}" 
                           placeholder="Enter all team member names (e.g., John Doe, Jane Smith)" value="">
                `;
                container.appendChild(div);
            }
        }
        
        // Start the game
        function startGame() {
            const numTeams = parseInt(document.getElementById('numTeams').value);
            teams = [];
            
            // Collect team names and members
            for (let i = 1; i <= numTeams; i++) {
                const memberNames = document.getElementById(`team${i}`).value || `Team ${i}`;
                teams.push({ 
                    name: `Team ${i}`, 
                    members: memberNames,
                    score: 0 
                });
            }
            
            // Switch to game section
            document.getElementById('setupSection').classList.remove('active');
            document.getElementById('gameSection').classList.add('active');
            
            // Initialize game
            initializeGame();
        }
        
        // Initialize game board and scoring
        function initializeGame() {
            displayTeamScores();
            setupGameBoard();
            gameActive = true;
            currentTeam = 0;
            updateCurrentTeam();
        }
        
        // Display team scores
        function displayTeamScores() {
            const scoresContainer = document.getElementById('teamScores');
            scoresContainer.innerHTML = '';
            
            teams.forEach((team, index) => {
                const scoreCard = document.createElement('div');
                scoreCard.className = 'team-score-card';
                scoreCard.id = `team-${index}`;
                scoreCard.innerHTML = `
                    <h5>${team.name}</h5>
                    <div class="h3 mb-0">${team.score}</div>
                `;
                scoresContainer.appendChild(scoreCard);
            });
        }
        
        // Setup game board
        function setupGameBoard() {
            const gameBoard = document.getElementById('gameBoard');
            gameBoard.innerHTML = '';
            
            // Create headers
            const headers = ['Category 1', 'Category 2', 'Category 3', 'Category 4'];
            headers.forEach(header => {
                const headerCell = document.createElement('div');
                headerCell.className = 'jeopardy-cell jeopardy-header';
                headerCell.textContent = header;
                gameBoard.appendChild(headerCell);
            });
            
            // Create point values
            const pointValues = [100, 200, 300, 400, 500];
            pointValues.forEach(points => {
                for (let col = 0; col < 4; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'jeopardy-cell';
                    cell.textContent = points;
                    cell.onclick = () => handleCellClick(points, col);
                    gameBoard.appendChild(cell);
                }
            });
        }
        
        // Handle game board cell click
        function handleCellClick(points, category) {
            if (!gameActive) return;
            if (event.target.classList.contains('used')) return;
            
            // Find a question with matching points
            const question = vocabularyData.find(q => parseInt(q.points) === points && !q.used);
            if (!question) {
                alert('No questions available for this point value');
                return;
            }
            
            question.used = true;
            currentQuestion = question;
            currentPoints = points;
            
            event.target.classList.add('used');
            showQuestion();
        }
        
        // Show question modal
        function showQuestion(isSteal = false) {
            const modal = document.getElementById('questionModal');
            const pointsText = isSteal ? `${currentPoints} Points (STEAL) - ${teams[currentTeam].name}'s Turn` : `${currentPoints} Points - ${teams[currentTeam].name}'s Turn`;
            document.getElementById('questionPoints').textContent = pointsText;
            document.getElementById('questionText').textContent = currentQuestion.definition;
            
            // Display answer options
            const optionsContainer = document.getElementById('answerOptions');
            optionsContainer.innerHTML = '';
            
            currentQuestion.choices.forEach((choice, index) => {
                const btn = document.createElement('button');
                btn.className = 'answer-option';
                btn.textContent = choice;
                btn.type = 'button'; // Ensure it's a button
                
                // Use a closure to capture the choice and button element
                (function(selectedChoice, buttonElement) {
                    btn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        checkAnswer(selectedChoice === currentQuestion.correct, isSteal, buttonElement);
                    };
                })(choice, btn);
                
                optionsContainer.appendChild(btn);
            });
            
            modal.classList.add('show');
            startQuestionTimer(isSteal);
        }
        
        // Start question timer
        function startQuestionTimer(isSteal = false) {
            let timeLeft = 30;
            const timerDisplay = document.getElementById('modalTimer');
            
            if (questionTimer) clearInterval(questionTimer);
            
            questionTimer = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                
                if (timeLeft <= 10) {
                    timerDisplay.classList.add('warning');
                }
                if (timeLeft <= 5) {
                    timerDisplay.classList.remove('warning');
                    timerDisplay.classList.add('danger');
                }
                
                if (timeLeft <= 0) {
                    clearInterval(questionTimer);
                    try {
                        playSound('ding-ding'); // Time's up warning
                    } catch (e) {
                        console.log('Sound error:', e);
                    }
                    checkAnswer(false, isSteal, null);
                }
            }, 1000);
        }
        
        // Check answer
        function checkAnswer(isCorrect, isSteal = false, clickedElement = null) {
            clearInterval(questionTimer);
            
            // Disable all options immediately to prevent double-clicks
            const options = document.querySelectorAll('.answer-option');
            options.forEach(option => {
                option.disabled = true;
                option.style.pointerEvents = 'none';
            });
            
            if (isCorrect) {
                // Correct answer
                try {
                    playSound('correct'); // Play correct sound
                } catch (e) {
                    console.log('Sound error:', e);
                }
                
                options.forEach(option => {
                    if (option.textContent === currentQuestion.correct) {
                        option.classList.add('correct');
                    }
                });
                
                teams[currentTeam].score += currentPoints;
                displayTeamScores();
                
                setTimeout(() => {
                    closeQuestion();
                    nextTeam();
                }, 2000);
            } else {
                // Incorrect answer
                try {
                    playSound('incorrect'); // Play incorrect sound
                } catch (e) {
                    console.log('Sound error:', e);
                }
                
                if (!isSteal) {
                    // First attempt wrong - offer steal
                    setTimeout(() => {
                        closeQuestion();
                        if (confirm(`Incorrect! Next team can steal for ${Math.floor(currentPoints/2)} points?`)) {
                            nextTeam();
                            currentPoints = Math.floor(currentPoints / 2);
                            showQuestion(true);
                        } else {
                            revealAnswer();
                            setTimeout(() => {
                                nextTeam();
                            }, 2000);
                        }
                    }, 1000);
                } else {
                    // Steal attempt failed - show correct answer
                    options.forEach(option => {
                        if (option.textContent === currentQuestion.correct) {
                            option.classList.add('correct');
                        } else if (clickedElement && option === clickedElement) {
                            option.classList.add('incorrect');
                        }
                    });
                    
                    setTimeout(() => {
                        closeQuestion();
                        nextTeam();
                    }, 3000);
                }
            }
        }
        
        // Reveal correct answer
        function revealAnswer() {
            const modal = document.getElementById('questionModal');
            modal.classList.add('show');
            
            document.getElementById('questionPoints').textContent = 'Answer Revealed';
            
            const options = document.querySelectorAll('.answer-option');
            options.forEach(option => {
                option.disabled = true;
                if (option.textContent === currentQuestion.correct) {
                    option.classList.add('correct');
                }
            });
            
            setTimeout(() => {
                closeQuestion();
            }, 2000);
        }
        
        // Close question modal
        function closeQuestion() {
            document.getElementById('questionModal').classList.remove('show');
            document.getElementById('modalTimer').classList.remove('warning', 'danger');
            
            // Reset timer display
            document.getElementById('modalTimer').textContent = '30';
            
            // Check if game is over
            const unusedQuestions = vocabularyData.filter(q => !q.used);
            if (unusedQuestions.length === 0) {
                endGame();
            }
        }
        
        // Move to next team
        function nextTeam() {
            currentTeam = (currentTeam + 1) % teams.length;
            updateCurrentTeam();
        }
        
        // Update current team display
        function updateCurrentTeam() {
            document.getElementById('currentTeamDisplay').textContent = `Current Turn: ${teams[currentTeam].name}`;
            
            document.querySelectorAll('.team-score-card').forEach((card, index) => {
                card.classList.remove('active');
                if (index === currentTeam) {
                    card.classList.add('active');
                }
            });
        }
        
        // End game and show results
        function endGame() {
            gameActive = false;
            
            // Sort teams by score (highest first)
            const sortedTeams = [...teams].sort((a, b) => b.score - a.score);
            
            // Create rankings display with proper tie handling
            const finalScoresContainer = document.getElementById('finalScores');
            finalScoresContainer.innerHTML = '';
            
            const rankingsDiv = document.createElement('div');
            rankingsDiv.className = 'row justify-content-center';
            
            let currentRank = 1;
            let previousScore = null;
            let teamsAtSameRank = 0;
            
            sortedTeams.forEach((team, index) => {
                // Handle tie logic
                if (previousScore !== null && team.score !== previousScore) {
                    // Score changed, update rank
                    currentRank = index + 1;
                    teamsAtSameRank = 0;
                } else if (previousScore === team.score) {
                    // Same score as previous team (tie)
                    teamsAtSameRank++;
                }
                
                previousScore = team.score;
                
                const colDiv = document.createElement('div');
                colDiv.className = 'col-md-6 mb-3';
                
                const scoreCard = document.createElement('div');
                scoreCard.className = 'team-score-card text-center p-4';
                
                // Determine rank display and styling
                let rankIcon = '';
                let rankText = '';
                let isTie = teamsAtSameRank > 0 || (index < sortedTeams.length - 1 && sortedTeams[index + 1].score === team.score);
                
                if (currentRank === 1) {
                    rankIcon = '🥇';
                    rankText = isTie ? '1st Place (Tie)' : '1st Place';
                    scoreCard.style.background = 'linear-gradient(135deg, #fff3cd, #ffeaa7)';
                    scoreCard.style.border = '3px solid #ffc107';
                } else if (currentRank === 2) {
                    rankIcon = '🥈';
                    rankText = isTie ? '2nd Place (Tie)' : '2nd Place';
                    scoreCard.style.background = 'linear-gradient(135deg, #e9ecef, #dee2e6)';
                    scoreCard.style.border = '2px solid #6c757d';
                } else if (currentRank === 3) {
                    rankIcon = '🥉';
                    rankText = isTie ? '3rd Place (Tie)' : '3rd Place';
                    scoreCard.style.background = 'linear-gradient(135deg, #f8d7da, #f5c2c7)';
                    scoreCard.style.border = '2px solid #dc3545';
                } else {
                    rankIcon = '🏆';
                    rankText = isTie ? `${getOrdinalSuffix(currentRank)} Place (Tie)` : `${getOrdinalSuffix(currentRank)} Place`;
                    scoreCard.style.background = 'linear-gradient(135deg, #f8f9fa, #e9ecef)';
                    scoreCard.style.border = '2px solid #6c757d';
                }
                
                scoreCard.innerHTML = `
                    <div class="h1 mb-2">${rankIcon}</div>
                    <h4 class="mb-2">${rankText}</h4>
                    <h5 class="text-primary">${team.name}</h5>
                    <div class="h2 mb-0">${team.score} points</div>
                `;
                
                colDiv.appendChild(scoreCard);
                rankingsDiv.appendChild(colDiv);
            });
            
            finalScoresContainer.appendChild(rankingsDiv);
            
            // Switch to complete section
            document.getElementById('gameSection').classList.remove('active');
            document.getElementById('completeSection').classList.add('active');
        }
        
        // Helper function to get ordinal suffix (1st, 2nd, 3rd, 4th, etc.)
        function getOrdinalSuffix(num) {
            const j = num % 10;
            const k = num % 100;
            if (j == 1 && k != 11) {
                return num + "st";
            }
            if (j == 2 && k != 12) {
                return num + "nd";
            }
            if (j == 3 && k != 13) {
                return num + "rd";
            }
            return num + "th";
        }
        
        // Restart game with same teams
        function playAgain() {
            // Reset all game state
            teams.forEach(team => team.score = 0);
            vocabularyData.forEach(item => item.used = false);
            currentTeam = 0;
            
            // Switch back to game section
            document.getElementById('completeSection').classList.remove('active');
            document.getElementById('gameSection').classList.add('active');
            
            // Reinitialize game
            initializeGame();
        }
        
        // Go back to chapter selection
        function selectNewChapter() {
            window.location.href = 'index.html';
        }
        
        // Generate and download certificate
        function generateCertificate() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Get current date
            const currentDate = new Date().toLocaleDateString();
            
            // Sort teams for certificate
            const sortedTeams = [...teams].sort((a, b) => b.score - a.score);
            
            // Certificate styling
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(24);
            doc.setTextColor(46, 134, 171); // #2e86ab color
            
            // Title
            doc.text('VOCABULARY GAME CERTIFICATE', 105, 30, { align: 'center' });
            
            // Subtitle
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text(`Chapter ${currentChapter} - Principles of Applied Engineering`, 105, 45, { align: 'center' });
            
            // Date and instructor
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(12);
            doc.text(`Date: ${currentDate}`, 20, 60);
            doc.text('Instructor: Mark Johnston', 20, 70);
            
            // Results section
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.text('GAME RESULTS:', 20, 90);
            
            // Team results
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(11);
            let yPosition = 105;
            
            let currentRank = 1;
            let previousScore = null;
            let teamsAtSameRank = 0;
            
            sortedTeams.forEach((team, index) => {
                // Handle tie logic for certificate
                if (previousScore !== null && team.score !== previousScore) {
                    currentRank = index + 1;
                    teamsAtSameRank = 0;
                } else if (previousScore === team.score) {
                    teamsAtSameRank++;
                }
                
                previousScore = team.score;
                
                let isTie = teamsAtSameRank > 0 || (index < sortedTeams.length - 1 && sortedTeams[index + 1].score === team.score);
                let rankText = isTie ? `${getOrdinalSuffix(currentRank)} Place (Tie)` : `${getOrdinalSuffix(currentRank)} Place`;
                
                // Add medal emoji equivalent
                let medal = '';
                if (currentRank === 1) medal = '[GOLD]';
                else if (currentRank === 2) medal = '[SILVER]';
                else if (currentRank === 3) medal = '[BRONZE]';
                
                doc.setFont('helvetica', 'bold');
                doc.text(`${medal} ${rankText} - ${team.score} points`, 25, yPosition);
                
                doc.setFont('helvetica', 'normal');
                doc.text(`Team Members: ${team.members}`, 25, yPosition + 8);
                
                yPosition += 20;
                
                // Start new page if needed
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 30;
                }
            });
            
            // Footer
            if (yPosition < 220) {
                doc.setFont('helvetica', 'italic');
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text('Generated by Mark Johnston\'s Classroom Vocabulary Game', 105, 280, { align: 'center' });
            }
            
            // Save the PDF
            const fileName = `Chapter_${currentChapter}_Vocabulary_Game_Results_${currentDate.replace(/\//g, '-')}.pdf`;
            doc.save(fileName);
        }
        
        // Sample data for testing when JSON file is not available
        function getSampleData() {
            return [
                {
                    "index": 0,
                    "points": "100",
                    "definition": "Guidelines that we use to help us make decisions about our behavior.",
                    "choices": [
                        "moral principles",
                        "ethics",
                        "values", 
                        "behavioral standards"
                    ],
                    "correct": "ethics"
                },
                {
                    "index": 1,
                    "points": "200",
                    "definition": "Effects products have on financial systems.",
                    "choices": [
                        "market impact",
                        "economic impact",
                        "financial impact",
                        "commercial impact"
                    ],
                    "correct": "economic impact"
                },
                {
                    "index": 2,
                    "points": "300",
                    "definition": "Type of design that focuses on creating products that are not harmful to the environment throughout their life cycle.",
                    "choices": [
                        "sustainable design",
                        "eco-friendly design", 
                        "green design",
                        "environmentally conscious design"
                    ],
                    "correct": "green design"
                },
                {
                    "index": 3,
                    "points": "400",
                    "definition": "Sets of guidelines that should be followed when engineers interact with the public, their employers, their clients, and other engineers.",
                    "choices": [
                        "professional standards",
                        "industry regulations",
                        "legal requirements",
                        "codes of ethics"
                    ],
                    "correct": "codes of ethics"
                },
                {
                    "index": 4,
                    "points": "500",
                    "definition": "Designation for engineers who have completed licensure requirements, allowing engineers to approve, sign, and stamp plans and documents.",
                    "choices": [
                        "Licensed Engineer (L.E.)",
                        "Professional Engineer (P.E.)",
                        "Certified Engineer (C.E.)",
                        "Registered Engineer (R.E.)"
                    ],
                    "correct": "Professional Engineer (P.E.)"
                }
            ];
        }
    </script>
</body>
</html>