<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PAE Vocabulary Game Certificate</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
      /* Print-friendly styles */
      @media print {
        @page {
          size: letter;
          margin: 0;
        }
        
        body {
          margin: 0;
          background: white !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
          color-adjust: exact !important;
        }
        
        .no-print {
          display: none !important;
        }
        
        .certificate-page {
          min-height: 100vh !important;
          padding: 0 !important;
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
        }
        
        .certificate-wrapper {
          transform: scale(0.9);
          transform-origin: center center;
        }
        
        .certificate-container {
          box-shadow: none !important;
          page-break-inside: avoid;
        }
        
        /* Ensure backgrounds print */
        * {
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
          color-adjust: exact !important;
        }
      }

      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        margin: 0;
        padding: 0;
      }

      .certificate-page {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .certificate-wrapper {
        width: 850px;
        max-width: 100%;
      }

      .certificate-container {
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        position: relative;
        overflow: visible;
      }

      /* Decorative border */
      .certificate-border {
        border: 3px solid #667eea;
        border-radius: 10px;
        padding: 40px;
        position: relative;
        background: white;
      }

      /* Corner decorations */
      .corner-decoration {
        position: absolute;
        width: 60px;
        height: 60px;
        border: 3px solid #764ba2;
      }

      .corner-decoration.top-left {
        top: -3px;
        left: -3px;
        border-right: none;
        border-bottom: none;
        border-top-left-radius: 10px;
      }

      .corner-decoration.top-right {
        top: -3px;
        right: -3px;
        border-left: none;
        border-bottom: none;
        border-top-right-radius: 10px;
      }

      .corner-decoration.bottom-left {
        bottom: -3px;
        left: -3px;
        border-right: none;
        border-top: none;
        border-bottom-left-radius: 10px;
      }

      .corner-decoration.bottom-right {
        bottom: -3px;
        right: -3px;
        border-left: none;
        border-top: none;
        border-bottom-right-radius: 10px;
      }

      .certificate-header {
        text-align: center;
        margin-bottom: 30px;
      }

      .certificate-title {
        color: #2e86ab;
        font-size: 2.2rem;
        font-weight: bold;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
      }

      .trophy-icon {
        color: #ffc107;
        font-size: 2.5rem;
      }

      .certificate-subtitle {
        color: #333;
        font-size: 1.3rem;
        margin-bottom: 10px;
        font-weight: 500;
      }

      .certificate-course {
        color: #666;
        font-size: 1rem;
        font-style: italic;
      }

      .game-info {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
        border: 1px solid #dee2e6;
      }

      .game-info-row {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 20px;
      }

      .info-item {
        flex: 1;
        min-width: 200px;
      }

      .info-label {
        font-weight: 600;
        color: #495057;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .info-value {
        color: #212529;
        font-size: 1.1rem;
        margin-top: 5px;
      }

      .alert-warning {
        background: #fff3cd;
        border: 1px solid #ffc107;
        color: #856404;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
      }

      .results-section {
        margin: 30px 0;
      }

      .results-header {
        text-align: center;
        margin-bottom: 25px;
        font-size: 1.5rem;
        color: #2c3e50;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
      }

      .star-icon {
        color: #ffc107;
      }

      .team-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        border: 2px solid #dee2e6;
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .team-card.gold {
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        border: 3px solid #ffc107;
      }

      .team-card.silver {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border: 2px solid #6c757d;
      }

      .team-card.bronze {
        background: linear-gradient(135deg, #ffeee9, #ffd4c4);
        border: 2px solid #dc3545;
      }

      .rank-display {
        text-align: center;
        min-width: 80px;
      }

      .rank-icon {
        font-size: 3rem;
        line-height: 1;
      }

      .rank-text {
        font-size: 0.9rem;
        color: #666;
        margin-top: 5px;
      }

      .team-details {
        flex: 1;
      }

      .team-name {
        font-size: 1.3rem;
        font-weight: 600;
        color: #212529;
        margin-bottom: 5px;
      }

      .team-score {
        font-size: 1.8rem;
        color: #007bff;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .team-members {
        color: #666;
        font-size: 0.95rem;
      }

      .signature-section {
        margin-top: 40px;
        display: flex;
        justify-content: space-around;
        align-items: flex-end;
      }

      .signature-block {
        text-align: center;
        min-width: 200px;
      }

      .signature-image {
        height: 50px;
        width: auto;
        max-width: 180px;
        object-fit: contain;
        margin-bottom: 10px;
      }

      .signature-line {
        border-top: 2px solid #333;
        padding-top: 10px;
        font-size: 0.9rem;
        color: #666;
      }

      .certificate-footer {
        text-align: center;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #dee2e6;
        color: #6c757d;
        font-size: 0.85rem;
      }

      .action-buttons {
        text-align: center;
        margin-top: 30px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .btn-certificate {
        margin: 0 10px;
        padding: 12px 30px;
        font-size: 1rem;
        border-radius: 8px;
        font-weight: 500;
      }

      /* Loading overlay */
      .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        justify-content: center;
        align-items: center;
      }

      .loading-overlay.active {
        display: flex;
      }

      .loading-content {
        background: white;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
      }

      .spinner-border {
        width: 3rem;
        height: 3rem;
        margin-bottom: 15px;
      }
    </style>
  </head>
  <body>
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-content">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <div>Generating PDF...</div>
      </div>
    </div>

    <div class="certificate-page">
      <div class="certificate-wrapper">
        <div class="certificate-container" id="certificateContent">
          <div class="certificate-border">
            <div class="corner-decoration top-left"></div>
            <div class="corner-decoration top-right"></div>
            <div class="corner-decoration bottom-left"></div>
            <div class="corner-decoration bottom-right"></div>

            <div class="certificate-header">
              <h1 class="certificate-title">
                <i class="bi bi-trophy-fill trophy-icon"></i>
                <span>VOCABULARY GAME CERTIFICATE</span>
                <i class="bi bi-trophy-fill trophy-icon"></i>
              </h1>
              <div class="certificate-subtitle" id="chapterInfo">Loading...</div>
              <div class="certificate-course">Principles of Applied Engineering</div>
            </div>

            <div class="game-info">
              <div class="game-info-row">
                <div class="info-item">
                  <div class="info-label">Date</div>
                  <div class="info-value" id="gameDate"></div>
                </div>
                <div class="info-item">
                  <div class="info-label">Instructor</div>
                  <div class="info-value">Mark Johnston</div>
                </div>
                <div class="info-item">
                  <div class="info-label">Questions</div>
                  <div class="info-value" id="questionsCompleted"></div>
                </div>
              </div>
            </div>

            <div id="earlyEndNotice" class="alert-warning" style="display: none">
              <i class="bi bi-exclamation-triangle"></i>
              <strong>Note:</strong> <span id="earlyEndText"></span>
            </div>

            <div class="results-section">
              <h2 class="results-header">
                <i class="bi bi-star-fill star-icon"></i>
                Game Results
                <i class="bi bi-star-fill star-icon"></i>
              </h2>
              <div id="teamResultsContainer"></div>
            </div>

            <div class="signature-section">
              <div class="signature-block">
                <img src="/images/signature.png" alt="Signature" class="signature-image" id="signatureImg">
                <div class="signature-line">Instructor Signature</div>
              </div>
              <div class="signature-block">
                <div style="height: 40px; font-size: 1.2rem; color: #333; font-family: 'Brush Script MT', cursive;" id="signatureDate"></div>
                <div class="signature-line">Date</div>
              </div>
            </div>

            <div class="certificate-footer">
              Generated by Mark Johnston's Classroom • PAE Vocabulary Game System
            </div>
          </div>
        </div>

        <div class="action-buttons no-print">
          <button class="btn btn-success btn-certificate" onclick="generatePDF()">
            <i class="bi bi-file-pdf"></i> Download PDF
          </button>
          <button class="btn btn-primary btn-certificate" onclick="window.print()">
            <i class="bi bi-printer"></i> Print Certificate
          </button>
          <button class="btn btn-secondary btn-certificate" onclick="window.close()">
            <i class="bi bi-x-circle"></i> Close
          </button>
        </div>
      </div>
    </div>

    <script>
      let certificateData = null;

      document.addEventListener("DOMContentLoaded", function () {
        const dataStr = localStorage.getItem("certificateData");
        if (!dataStr) {
          alert("No certificate data found. Please generate certificate from the game.");
          window.close();
          return;
        }

        certificateData = JSON.parse(dataStr);
        displayCertificate();
        
        // Hide signature if image doesn't load
        document.getElementById('signatureImg').onerror = function() {
          this.style.display = 'none';
        };
      });

      function displayCertificate() {
        // Format date
        const gameDate = new Date(certificateData.gameDate);
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById("gameDate").textContent = gameDate.toLocaleDateString('en-US', options);

        // Add current date to signature line
        const today = new Date();
        const signatureDateOptions = { year: 'numeric', month: 'short', day: 'numeric' };
        document.getElementById("signatureDate").textContent = today.toLocaleDateString('en-US', signatureDateOptions);

        // Chapter info
        let chapterText = certificateData.chapterInfo;
        document.getElementById("chapterInfo").textContent = chapterText;

        // Questions completed
        document.getElementById("questionsCompleted").textContent = 
          `${certificateData.questionsAnswered} of ${certificateData.totalQuestions}`;

        // Early end notice
        if (certificateData.gameEndedEarly) {
          document.getElementById("earlyEndNotice").style.display = "block";
          document.getElementById("earlyEndText").textContent = 
            `Game ended early. ${certificateData.questionsAnswered} of ${certificateData.totalQuestions} questions were completed.`;
        }

        // Team results
        displayTeamResults();
      }

      function displayTeamResults() {
        const container = document.getElementById("teamResultsContainer");
        const sortedTeams = [...certificateData.teams].sort((a, b) => b.score - a.score);

        let currentRank = 1;
        let previousScore = null;

        sortedTeams.forEach((team, index) => {
          if (previousScore !== null && team.score !== previousScore) {
            currentRank = index + 1;
          }
          previousScore = team.score;

          const teamCard = document.createElement("div");
          teamCard.className = "team-card";

          // Add special styling for top 3
          if (currentRank === 1) teamCard.classList.add("gold");
          else if (currentRank === 2) teamCard.classList.add("silver");
          else if (currentRank === 3) teamCard.classList.add("bronze");

          let rankIcon = "";
          if (currentRank === 1) rankIcon = "🥇";
          else if (currentRank === 2) rankIcon = "🥈";
          else if (currentRank === 3) rankIcon = "🥉";
          else rankIcon = "🏆";

          const isTie = index < sortedTeams.length - 1 && sortedTeams[index + 1].score === team.score;
          const rankText = isTie ? `${getOrdinalSuffix(currentRank)} Place (Tie)` : 
                                   `${getOrdinalSuffix(currentRank)} Place`;

          teamCard.innerHTML = `
            <div class="rank-display">
              <div class="rank-icon">${rankIcon}</div>
              <div class="rank-text">${rankText}</div>
            </div>
            <div class="team-details">
              <div class="team-name">${team.name}</div>
              <div class="team-score">${team.score} points</div>
              <div class="team-members">
                <strong>Members:</strong> ${team.members}
              </div>
            </div>
          `;

          container.appendChild(teamCard);
        });
      }

      function getOrdinalSuffix(num) {
        const j = num % 10;
        const k = num % 100;
        if (j == 1 && k != 11) return num + "st";
        if (j == 2 && k != 12) return num + "nd";
        if (j == 3 && k != 13) return num + "rd";
        return num + "th";
      }

      async function generatePDF() {
        const loadingOverlay = document.getElementById('loadingOverlay');
        loadingOverlay.classList.add('active');

        try {
          // Hide buttons before capture
          const buttons = document.querySelector('.action-buttons');
          if (buttons) buttons.style.display = 'none';

          // Wait a moment for any animations to settle
          await new Promise(resolve => setTimeout(resolve, 100));

          // Use html2canvas to capture the certificate
          const element = document.getElementById('certificateContent');
          
          const canvas = await html2canvas(element, {
            scale: 2,
            useCORS: true,
            allowTaint: true,
            logging: false,
            backgroundColor: '#ffffff',
            width: element.scrollWidth,
            height: element.scrollHeight,
            windowWidth: element.scrollWidth,
            windowHeight: element.scrollHeight,
            onclone: (clonedDoc) => {
              // Ensure styles are applied to cloned document
              const clonedElement = clonedDoc.getElementById('certificateContent');
              if (clonedElement) {
                clonedElement.style.backgroundColor = '#ffffff';
                // Force all text to be visible
                const allElements = clonedElement.getElementsByTagName('*');
                for (let el of allElements) {
                  if (el.style) {
                    el.style.visibility = 'visible';
                    el.style.opacity = '1';
                  }
                }
              }
            }
          });

          // Show buttons again
          if (buttons) buttons.style.display = 'block';

          // Convert to PDF
          const imgData = canvas.toDataURL('image/png');
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'pt',
            format: 'letter'
          });

          // Letter size in points: 612 x 792
          const pdfWidth = pdf.internal.pageSize.getWidth();
          const pdfHeight = pdf.internal.pageSize.getHeight();
          
          // Calculate dimensions to fit the page with margins
          const margin = 40; // 40pt margins
          const maxWidth = pdfWidth - (2 * margin);
          const maxHeight = pdfHeight - (2 * margin);
          
          const imgWidth = canvas.width;
          const imgHeight = canvas.height;
          
          const widthRatio = maxWidth / imgWidth;
          const heightRatio = maxHeight / imgHeight;
          const ratio = Math.min(widthRatio, heightRatio);
          
          const scaledWidth = imgWidth * ratio;
          const scaledHeight = imgHeight * ratio;
          
          // Center the image
          const x = (pdfWidth - scaledWidth) / 2;
          const y = (pdfHeight - scaledHeight) / 2;

          pdf.addImage(imgData, 'PNG', x, y, scaledWidth, scaledHeight);

          // Generate filename
          const gameDate = new Date(certificateData.gameDate);
          const dateStr = gameDate.toLocaleDateString().replace(/\//g, "-");
          const modeText = certificateData.isRandomMode ? "_Random" : `_Ch${certificateData.currentChapter}`;
          const filename = `PAE_Certificate${modeText}_${dateStr}.pdf`;

          pdf.save(filename);
        } catch (error) {
          console.error('Error generating PDF:', error);
          
          // Fallback to simple PDF generation
          try {
            generateSimplePDF();
          } catch (fallbackError) {
            alert('Error generating PDF. Please try printing instead (Ctrl+P or Cmd+P).');
          }
        } finally {
          loadingOverlay.classList.remove('active');
          // Ensure buttons are visible
          const buttons = document.querySelector('.action-buttons');
          if (buttons) buttons.style.display = 'block';
        }
      }

      // Fallback simple PDF generation
      function generateSimplePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Title
        doc.setFont("helvetica", "bold");
        doc.setFontSize(20);
        doc.setTextColor(46, 134, 171);
        doc.text("VOCABULARY GAME CERTIFICATE", 105, 30, { align: "center" });

        // Subtitle
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        doc.text(certificateData.chapterInfo, 105, 45, { align: "center" });
        doc.text("Principles of Applied Engineering", 105, 55, { align: "center" });

        // Border
        doc.setDrawColor(102, 126, 234);
        doc.setLineWidth(1);
        doc.rect(15, 15, 180, 267);

        // Game info
        doc.setFont("helvetica", "normal");
        doc.setFontSize(11);
        const gameDate = new Date(certificateData.gameDate);
        doc.text(`Date: ${gameDate.toLocaleDateString()}`, 30, 75);
        doc.text("Instructor: Mark Johnston", 30, 85);
        doc.text(`Questions Completed: ${certificateData.questionsAnswered}/${certificateData.totalQuestions}`, 30, 95);

        // Results header
        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.text("GAME RESULTS", 105, 115, { align: "center" });

        // Team results
        let yPos = 130;
        const sortedTeams = [...certificateData.teams].sort((a, b) => b.score - a.score);
        let currentRank = 1;
        let previousScore = null;

        sortedTeams.forEach((team, index) => {
          if (previousScore !== null && team.score !== previousScore) {
            currentRank = index + 1;
          }
          previousScore = team.score;

          const rankText = `${getOrdinalSuffix(currentRank)} Place`;
          let medal = "";
          if (currentRank === 1) medal = "[GOLD] ";
          else if (currentRank === 2) medal = "[SILVER] ";
          else if (currentRank === 3) medal = "[BRONZE] ";

          doc.setFont("helvetica", "bold");
          doc.setFontSize(12);
          doc.text(`${medal}${rankText}`, 30, yPos);
          
          doc.setFont("helvetica", "normal");
          doc.setFontSize(11);
          doc.text(`${team.name}: ${team.score} points`, 30, yPos + 10);
          doc.setFontSize(10);
          doc.text(`Members: ${team.members}`, 30, yPos + 20);

          yPos += 35;

          if (yPos > 250) {
            doc.addPage();
            yPos = 30;
          }
        });

        // Signature lines
        if (yPos < 220) {
          doc.line(30, 250, 80, 250);
          doc.text("Instructor Signature", 55, 260, { align: "center" });
          
          doc.line(130, 250, 180, 250);
          doc.text("Date", 155, 260, { align: "center" });
        }

        // Footer
        doc.setFont("helvetica", "italic");
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        doc.text("Generated by Mark Johnston's Classroom Vocabulary Game", 105, 280, { align: "center" });

        // Generate filename
        const dateStr = gameDate.toLocaleDateString().replace(/\//g, "-");
        const modeText = certificateData.isRandomMode ? "_Random" : `_Ch${certificateData.currentChapter}`;
        const filename = `PAE_Certificate${modeText}_${dateStr}.pdf`;

        doc.save(filename);
      }
    </script>
  </body>
</html>